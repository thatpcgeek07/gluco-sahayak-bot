const express = require('express');
const axios = require('axios');
const mongoose = require('mongoose');
const cron = require('node-cron');
const pdfParse = require('pdf-parse');
const fs = require('fs');
const path = require('path');
const { promisify } = require('util');
const stream = require('stream');
const pipeline = promisify(stream.pipeline);

const app = express();
app.use(express.json());

// Configuration
const PORT = process.env.PORT || 3000;
const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_ID = process.env.WHATSAPP_PHONE_ID;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN;
const MONGODB_URI = process.env.MONGODB_URI;
const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;
const PHYSICIAN_PHONE = process.env.PHYSICIAN_PHONE;

// Google Drive Configuration
const GOOGLE_DRIVE_FOLDER_ID = '1Z2WciU7hJLGua1kQ61Q3ZnnPr2iMyy0Q';

// Medical textbooks mapping
const MEDICAL_TEXTBOOKS = {
  'icmr': { source: 'ICMR_Guidelines', keywords: ['icmr', 'guidelines', 'india'] },
  'park': { source: 'Parks_PSM', keywords: ['park', 'psm', 'preventive'] },
  'usmle': { source: 'USMLE_FirstAid', keywords: ['usmle', 'first aid', 'step'] },
  'williams': { source: 'Williams_Endocrinology', keywords: ['williams', 'endocrinology'] },
  'harrison': { source: 'Harrison_Internal_Medicine', keywords: ['harrison', 'internal medicine'] }
};

// Claude Sonnet 4
const CLAUDE_API_URL = 'https://api.anthropic.com/v1/messages';
const CLAUDE_MODEL = 'claude-sonnet-4-20250514';
let isClaudeAvailable = false;
let ragSystemInitialized = false;

// Medical Knowledge Base Schema
const medicalKnowledgeSchema = new mongoose.Schema({
  source: { 
    type: String, 
    enum: ['ICMR_Guidelines', 'Parks_PSM', 'USMLE_FirstAid', 'Williams_Endocrinology', 'Harrison_Internal_Medicine'],
    required: true 
  },
  chapter: String,
  section: String,
  topic: String,
  content: { type: String, required: true },
  keywords: [String],
  pageNumber: Number,
  chunkIndex: Number,
  lastUpdated: { type: Date, default: Date.now }
});

medicalKnowledgeSchema.index({ content: 'text', keywords: 'text', topic: 'text' });
medicalKnowledgeSchema.index({ source: 1, keywords: 1 });

const MedicalKnowledge = mongoose.model('MedicalKnowledge', medicalKnowledgeSchema);

// Triage Schema
const triageSchema = new mongoose.Schema({
  patientPhone: String,
  timestamp: { type: Date, default: Date.now },
  urgencyLevel: { 
    type: String, 
    enum: ['EMERGENCY', 'URGENT', 'ROUTINE', 'MONITORING'],
    required: true 
  },
  symptoms: [String],
  glucoseReading: Number,
  aiAssessment: String,
  medicalReferences: [{ source: String, content: String }],
  physicianAlerted: Boolean,
  resolution: String
});

const Triage = mongoose.model('Triage', triageSchema);

// Existing schemas
const patientSchema = new mongoose.Schema({
  phone: String,
  name: String,
  age: Number,
  diabetesType: String,
  registeredAt: { type: Date, default: Date.now },
  medicationSchedule: [{ medicationName: String, time: String }],
  reminderPreferences: { glucoseLogging: Boolean, medication: Boolean },
  riskProfile: {
    hasComplications: Boolean,
    comorbidities: [String],
    lastEmergency: Date
  }
});

const glucoseReadingSchema = new mongoose.Schema({
  patientPhone: String,
  reading: Number,
  readingType: { type: String, enum: ['fasting', 'postprandial', 'random'] },
  timestamp: { type: Date, default: Date.now },
  symptoms: [String],
  notes: String,
  alertSent: Boolean,
  triageId: mongoose.Schema.Types.ObjectId
});

const conversationSchema = new mongoose.Schema({
  patientPhone: String,
  messages: [{ role: String, content: String, timestamp: Date }],
  lastActive: Date,
  medicalReferencesUsed: [String]
});

const Patient = mongoose.model('Patient', patientSchema);
const GlucoseReading = mongoose.model('GlucoseReading', glucoseReadingSchema);
const Conversation = mongoose.model('Conversation', conversationSchema);

mongoose.connect(MONGODB_URI).then(async () => {
  console.log('âœ… MongoDB connected');
  // Initialize RAG system on startup
  await initializeRAGSystem();
}).catch(err => console.error('âŒ MongoDB:', err.message));

// ========================================
// GOOGLE DRIVE PDF DOWNLOADER
// ========================================

// Convert Google Drive folder link to API endpoint
function getGoogleDriveFilesList(folderId) {
  // Use Google Drive API v3 public access
  return `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=AIzaSyDummyKeyForPublicAccess&fields=files(id,name,mimeType)`;
}

// Download file from Google Drive
async function downloadFromGoogleDrive(fileId, filename) {
  try {
    const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
    
    const response = await axios({
      method: 'GET',
      url: downloadUrl,
      responseType: 'arraybuffer',
      timeout: 60000 // 60 seconds
    });

    const filePath = path.join('/tmp', filename);
    fs.writeFileSync(filePath, response.data);
    
    console.log(`âœ… Downloaded: ${filename}`);
    return filePath;
  } catch (error) {
    console.error(`âŒ Download failed for ${filename}:`, error.message);
    
    // Try alternative download method
    try {
      const altUrl = `https://drive.google.com/u/0/uc?id=${fileId}&export=download&confirm=t`;
      const response = await axios({
        method: 'GET',
        url: altUrl,
        responseType: 'arraybuffer',
        timeout: 60000
      });
      
      const filePath = path.join('/tmp', filename);
      fs.writeFileSync(filePath, response.data);
      console.log(`âœ… Downloaded (alt method): ${filename}`);
      return filePath;
    } catch (altError) {
      console.error(`âŒ Alt download also failed: ${altError.message}`);
      return null;
    }
  }
}

// Manual file IDs (extracted from your shared drive)
// You'll need to get individual file IDs from Google Drive
const MEDICAL_PDF_FILES = [
  // Add your file IDs here after inspecting the shared folder
  // Format: { fileId: 'xxx', filename: 'icmr_guidelines.pdf', source: 'ICMR_Guidelines' }
];

// Fallback: If we can't auto-detect, use direct links
async function downloadMedicalPDFs() {
  console.log('ğŸ“š Starting medical textbook download...');
  
  const downloadedFiles = [];
  
  // Method 1: Try to list files in folder (may require API key)
  try {
    // For now, we'll use manual specification
    // In production, you'd either:
    // 1. Make files publicly accessible with direct links
    // 2. Use Google Drive API with service account
    // 3. Upload files directly to server storage
    
    console.log('â„¹ï¸  Note: For full automation, individual file IDs needed');
    console.log('â„¹ï¸  Please provide direct file links or individual file IDs');
    
  } catch (error) {
    console.error('âŒ Could not list Google Drive files:', error.message);
  }
  
  return downloadedFiles;
}

// ========================================
// PDF PROCESSING & RAG SYSTEM
// ========================================

function extractKeywords(text) {
  const keywords = [];
  const diabetesTerms = [
    'diabetes', 'glucose', 'insulin', 'hyperglycemia', 'hypoglycemia',
    'HbA1c', 'blood sugar', 'pancreas', 'type 1', 'type 2', 'mellitus',
    'metformin', 'glycemic', 'fasting', 'postprandial', 'complications',
    'retinopathy', 'neuropathy', 'nephropathy', 'cardiovascular',
    'diet', 'exercise', 'medication', 'management', 'monitoring',
    'glycosylated hemoglobin', 'oral glucose tolerance', 'self-monitoring',
    'insulin resistance', 'beta cell', 'carbohydrate', 'lipid', 'protein'
  ];

  const lowerText = text.toLowerCase();
  diabetesTerms.forEach(term => {
    if (lowerText.includes(term)) {
      keywords.push(term);
    }
  });

  return [...new Set(keywords)];
}

async function processPDFFile(filePath, source) {
  try {
    console.log(`ğŸ“– Processing ${source}...`);
    
    const dataBuffer = fs.readFileSync(filePath);
    const data = await pdfParse(dataBuffer);
    
    // Split into meaningful chunks (paragraphs with context)
    const text = data.text;
    const chunks = [];
    
    // Split by double newlines (paragraphs)
    const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 150);
    
    // Group into chunks of 2-3 paragraphs for better context
    for (let i = 0; i < paragraphs.length; i += 2) {
      const chunk = paragraphs.slice(i, i + 2).join('\n\n');
      if (chunk.length > 200) {
        chunks.push(chunk);
      }
    }

    console.log(`ğŸ“„ ${source}: ${chunks.length} chunks extracted`);

    // Store in database
    let stored = 0;
    for (let i = 0; i < chunks.length; i++) {
      const chunk = chunks[i];
      const keywords = extractKeywords(chunk);
      
      if (keywords.length > 0) {
        await MedicalKnowledge.create({
          source,
          content: chunk,
          keywords,
          pageNumber: Math.floor(i / 2),
          chunkIndex: i
        });
        stored++;
      }
    }

    console.log(`âœ… ${source}: Stored ${stored} chunks in database`);
    
    // Clean up temp file
    fs.unlinkSync(filePath);
    
    return stored;
  } catch (error) {
    console.error(`âŒ Error processing ${source}:`, error.message);
    return 0;
  }
}

// Initialize RAG system
async function initializeRAGSystem() {
  try {
    console.log('ğŸš€ Initializing RAG System...');
    
    // Check if medical knowledge already exists
    const existingCount = await MedicalKnowledge.countDocuments();
    
    if (existingCount > 100) {
      console.log(`âœ… RAG System already initialized (${existingCount} chunks)`);
      ragSystemInitialized = true;
      return;
    }

    console.log('ğŸ“š Medical knowledge base empty. Need to process PDFs.');
    console.log('');
    console.log('ğŸ”— SETUP REQUIRED:');
    console.log('Your Google Drive folder: https://drive.google.com/drive/folders/1Z2WciU7hJLGua1kQ61Q3ZnnPr2iMyy0Q');
    console.log('');
    console.log('To enable automatic PDF processing:');
    console.log('1. Make each PDF file publicly accessible (right-click â†’ Share â†’ Anyone with link)');
    console.log('2. Get individual file IDs for each PDF');
    console.log('3. Call: POST /admin/process-google-drive-pdfs with file IDs');
    console.log('');
    console.log('OR upload PDFs directly via: POST /admin/upload-pdf');
    console.log('');
    
    ragSystemInitialized = false;
  } catch (error) {
    console.error('âŒ RAG initialization error:', error.message);
    ragSystemInitialized = false;
  }
}

// ========================================
// ADMIN ENDPOINTS FOR PDF UPLOAD
// ========================================

// Manual PDF upload endpoint
app.post('/admin/upload-pdf', async (req, res) => {
  try {
    const { source, pdfUrl } = req.body;
    
    if (!source || !pdfUrl) {
      return res.status(400).json({ 
        error: 'Missing source or pdfUrl',
        example: {
          source: 'ICMR_Guidelines',
          pdfUrl: 'https://drive.google.com/file/d/FILE_ID/view'
        }
      });
    }

    // Extract file ID from Google Drive URL
    const fileIdMatch = pdfUrl.match(/\/file\/d\/([^\/]+)/);
    if (!fileIdMatch) {
      return res.status(400).json({ error: 'Invalid Google Drive URL' });
    }

    const fileId = fileIdMatch[1];
    const filename = `${source}.pdf`;
    
    // Download PDF
    const filePath = await downloadFromGoogleDrive(fileId, filename);
    
    if (!filePath) {
      return res.status(500).json({ error: 'Download failed' });
    }

    // Process PDF
    const chunksStored = await processPDFFile(filePath, source);
    
    if (chunksStored > 0) {
      ragSystemInitialized = true;
      res.json({ 
        success: true, 
        message: `Processed ${source}: ${chunksStored} chunks stored`,
        source,
        chunks: chunksStored
      });
    } else {
      res.status(500).json({ error: 'No chunks could be stored' });
    }
    
  } catch (error) {
    console.error('Upload error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Batch process multiple PDFs
app.post('/admin/process-all-pdfs', async (req, res) => {
  try {
    const { files } = req.body;
    
    if (!files || !Array.isArray(files)) {
      return res.status(400).json({ 
        error: 'Missing files array',
        example: {
          files: [
            { source: 'ICMR_Guidelines', fileId: 'xxx' },
            { source: 'Parks_PSM', fileId: 'yyy' }
          ]
        }
      });
    }

    const results = [];
    
    for (const file of files) {
      const { source, fileId } = file;
      const filename = `${source}.pdf`;
      
      console.log(`Processing ${source}...`);
      
      const filePath = await downloadFromGoogleDrive(fileId, filename);
      
      if (filePath) {
        const chunksStored = await processPDFFile(filePath, source);
        results.push({ source, success: true, chunks: chunksStored });
      } else {
        results.push({ source, success: false, error: 'Download failed' });
      }
    }

    if (results.some(r => r.success)) {
      ragSystemInitialized = true;
    }

    res.json({ 
      success: true, 
      message: 'Batch processing complete',
      results
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Check RAG system status
app.get('/admin/rag-status', async (req, res) => {
  try {
    const totalChunks = await MedicalKnowledge.countDocuments();
    const bySource = await MedicalKnowledge.aggregate([
      { $group: { _id: '$source', count: { $sum: 1 } } }
    ]);

    res.json({
      initialized: ragSystemInitialized,
      totalChunks,
      bySource,
      ready: totalChunks > 100
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ========================================
// RAG RETRIEVAL SYSTEM
// ========================================

async function retrieveMedicalKnowledge(query, topK = 5) {
  try {
    // Full-text search
    const results = await MedicalKnowledge
      .find(
        { $text: { $search: query } },
        { score: { $meta: 'textScore' } }
      )
      .sort({ score: { $meta: 'textScore' } })
      .limit(topK);

    if (results.length === 0) {
      // Fallback: keyword search
      const keywords = extractKeywords(query);
      if (keywords.length > 0) {
        const fallbackResults = await MedicalKnowledge
          .find({ keywords: { $in: keywords } })
          .limit(topK);
        return fallbackResults;
      }
    }

    return results;
  } catch (error) {
    console.error('âŒ RAG retrieval error:', error.message);
    return [];
  }
}

// ========================================
// TRIAGE SYSTEM
// ========================================

function assessUrgency(glucose, symptoms = []) {
  if (glucose < 54 || glucose > 400) return 'EMERGENCY';
  
  if (symptoms.some(s => 
    ['unconscious', 'confusion', 'seizure', 'chest pain', 'difficulty breathing'].includes(s.toLowerCase())
  )) return 'EMERGENCY';

  if (glucose < 70 || glucose > 250) return 'URGENT';
  
  if (symptoms.some(s => 
    ['severe pain', 'vomiting', 'severe headache', 'vision loss'].includes(s.toLowerCase())
  )) return 'URGENT';

  if (glucose > 180 || glucose < 80) return 'ROUTINE';

  return 'MONITORING';
}

async function createTriageRecord(phone, glucose, symptoms, aiAssessment, medicalRefs) {
  const urgency = assessUrgency(glucose, symptoms);
  
  const triage = await Triage.create({
    patientPhone: phone,
    urgencyLevel: urgency,
    symptoms,
    glucoseReading: glucose,
    aiAssessment,
    medicalReferences: medicalRefs,
    physicianAlerted: urgency === 'EMERGENCY' || urgency === 'URGENT'
  });

  console.log(`ğŸ¥ Triage: ${urgency} (${glucose} mg/dL)`);
  return triage;
}

// Initialize Claude
async function initializeClaude() {
  if (!ANTHROPIC_API_KEY || ANTHROPIC_API_KEY === 'your_anthropic_api_key_here') {
    console.warn('âš ï¸  Claude API key not set');
    return false;
  }

  try {
    const response = await axios.post(CLAUDE_API_URL, {
      model: CLAUDE_MODEL,
      max_tokens: 50,
      messages: [{ role: 'user', content: 'Hi' }]
    }, {
      headers: {
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json'
      },
      timeout: 10000
    });

    if (response.data?.content?.[0]?.text) {
      isClaudeAvailable = true;
      console.log(`âœ… Claude Sonnet 4 ready`);
      return true;
    }
  } catch (error) {
    console.error('âŒ Claude failed:', error.response?.data?.error?.message || error.message);
  }
  return false;
}

initializeClaude();

// Medical Thresholds
const THRESHOLDS = {
  fasting: { critical_low: 70, critical_high: 250 },
  postprandial: { critical_low: 70, critical_high: 300 },
  random: { critical_low: 70, critical_high: 250 }
};

// WhatsApp
async function sendWhatsAppMessage(to, message) {
  try {
    await axios.post(`https://graph.facebook.com/v18.0/${WHATSAPP_PHONE_ID}/messages`, {
      messaging_product: 'whatsapp',
      to,
      type: 'text',
      text: { body: message }
    }, { headers: { 'Authorization': `Bearer ${WHATSAPP_TOKEN}` } });
    console.log(`âœ… Sent to ${to}`);
  } catch (e) {
    console.error('âŒ Send failed');
  }
}

// Fallback response
function fallbackResponse(msg) {
  const lower = msg.toLowerCase();
  const num = msg.match(/(\d{2,3})/);
  const glucose = num ? parseInt(num[1]) : null;
  
  if (lower.match(/^(hi|hello|namaste)/)) {
    return `Hello! ğŸ™ I'm Gluco Sahayak with medical-grade guidance.\n\nğŸ“š Evidence-based advice from medical textbooks\nğŸ“Š Log glucose\nğŸ¥ Emergency protocols\n\nSend: "My sugar is 120" ğŸ˜Š`;
  }
  
  if (glucose && glucose >= 40 && glucose <= 500) {
    let r = `âœ… Logged: ${glucose} mg/dL\n\n`;
    
    if (glucose < 54) r += `ğŸš¨ğŸš¨ EMERGENCY! Severe hypoglycemia. Eat 15g carbs NOW. Call doctor immediately!`;
    else if (glucose < 70) r += `ğŸš¨ LOW! Eat 15g fast carbs. Rest 15min. Recheck.`;
    else if (glucose <= 100) r += `âœ… EXCELLENT! Normal range. Keep it up! ğŸ‘`;
    else if (glucose <= 125) r += `âš ï¸ PREDIABETES. More vegetables, walk 30min daily, see doctor.`;
    else if (glucose <= 180) r += `âš ï¸ ELEVATED. Review diet, exercise, medication.`;
    else if (glucose <= 250) r += `ğŸš¨ HIGH! Drink water, avoid sweets, walk 15min, recheck in 2hr.`;
    else if (glucose <= 400) r += `ğŸš¨ğŸš¨ SEVERE! Contact doctor NOW. Don't exercise. Watch for symptoms.`;
    else r += `ğŸš¨ğŸš¨ğŸš¨ CRITICAL EMERGENCY! Go to ER immediately!`;
    
    return r;
  }
  
  return `How can I help? I provide evidence-based guidance.\n\nğŸ“Š "My sugar is 120"\nğŸ½ï¸ "Diet advice"\nğŸš¶ "Exercise tips"`;
}

// Enhanced Claude AI with RAG
async function analyzeWithClaudeRAG(phone, msg) {
  if (!isClaudeAvailable) return fallbackResponse(msg);

  try {
    // Retrieve medical knowledge
    const medicalContext = ragSystemInitialized 
      ? await retrieveMedicalKnowledge(msg, 5)
      : [];
    
    const patient = await Patient.findOne({ phone });
    const readings = await GlucoseReading.find({ patientPhone: phone })
      .sort({ timestamp: -1 })
      .limit(5);

    // Build references section
    const references = medicalContext.length > 0
      ? medicalContext.map(doc => 
          `[${doc.source}]\n${doc.content.substring(0, 600)}...`
        ).join('\n\n---\n\n')
      : 'Medical knowledge base initializing. Using evidence-based protocols.';

    const system = `You are Gluco Sahayak, medical-grade diabetes assistant.

ğŸ¥ CRITICAL RULES:
1. ONLY use information from medical textbook excerpts below
2. ALWAYS cite source: [Source Name]
3. If info not in excerpts, say "Based on standard protocols..." and be conservative
4. Never invent medical facts

ğŸ“š MEDICAL TEXTBOOK EXCERPTS:
${references}

PATIENT DATA:
- Name: ${patient?.name || 'New'}
- Recent: ${readings.map(r => `${r.reading}mg/dL`).join(', ') || 'None'}

PROTOCOL:
1. Assess urgency if glucose mentioned
2. Cite specific textbook source
3. Evidence-based advice only
4. Safety warnings for critical values
5. Indian context: roti, dal, walking, yoga
6. Max 150 words, warm but precise

User: "${msg}"

Respond with medical citations:`;

    const response = await axios.post(CLAUDE_API_URL, {
      model: CLAUDE_MODEL,
      max_tokens: 500,
      system,
      messages: [{ role: 'user', content: msg }]
    }, {
      headers: {
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json'
      },
      timeout: 15000
    });

    const text = response.data?.content?.[0]?.text;
    if (text) {
      console.log(`âœ… Claude RAG (${medicalContext.length} refs)`);
      return text;
    }
  } catch (e) {
    console.error('âŒ Claude error:', e.message);
  }
  
  return fallbackResponse(msg);
}

function extractGlucose(msg) {
  const match = msg.match(/(\d{2,3})/);
  const reading = match ? parseInt(match[1]) : null;
  if (!reading || reading < 40 || reading > 500) return { hasReading: false };

  const lower = msg.toLowerCase();
  const type = lower.match(/fasting|empty|morning/) ? 'fasting' :
               lower.match(/after|post|lunch|dinner/) ? 'postprandial' : 'random';

  const symptoms = [];
  const symptomTerms = ['tired', 'dizzy', 'thirsty', 'blur', 'sweat', 'weak', 
                        'nausea', 'vomit', 'pain', 'confusion', 'headache'];
  symptomTerms.forEach(term => {
    if (lower.includes(term)) symptoms.push(term);
  });

  return { hasReading: true, reading, readingType: type, symptoms, notes: msg.substring(0, 200) };
}

async function checkCritical(reading, type, phone) {
  const t = THRESHOLDS[type] || THRESHOLDS.random;
  let critical = false;
  let alert = '';
  let urgency = 'MONITORING';

  if (reading < 54) {
    critical = true;
    urgency = 'EMERGENCY';
    alert = `ğŸš¨ğŸš¨ CRITICAL: SEVERE HYPOGLYCEMIA\nPatient: ${phone}\nReading: ${reading} mg/dL\nLife threatening!`;
  } else if (reading < t.critical_low) {
    critical = true;
    urgency = 'URGENT';
    alert = `ğŸš¨ URGENT: HYPOGLYCEMIA\nPatient: ${phone}\nReading: ${reading} mg/dL`;
  } else if (reading > 400) {
    critical = true;
    urgency = 'EMERGENCY';
    alert = `ğŸš¨ğŸš¨ CRITICAL: SEVERE HYPERGLYCEMIA\nPatient: ${phone}\nReading: ${reading} mg/dL`;
  } else if (reading > t.critical_high) {
    critical = true;
    urgency = 'URGENT';
    alert = `ğŸš¨ URGENT: HYPERGLYCEMIA\nPatient: ${phone}\nReading: ${reading} mg/dL`;
  }

  if (critical && PHYSICIAN_PHONE && PHYSICIAN_PHONE !== '+919876543210') {
    await sendWhatsAppMessage(PHYSICIAN_PHONE, alert);
    console.log(`ğŸ¥ ${urgency} alert sent`);
  }

  return { critical, urgency };
}

// Webhooks
app.get('/webhook', (req, res) => {
  if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === VERIFY_TOKEN) {
    console.log('âœ… Webhook OK');
    return res.status(200).send(req.query['hub.challenge']);
  }
  res.sendStatus(403);
});

app.post('/webhook', async (req, res) => {
  res.sendStatus(200);

  try {
    const msg = req.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
    if (!msg || msg.type !== 'text') return;

    const from = msg.from;
    const text = msg.text.body;

    const reply = await analyzeWithClaudeRAG(from, text);
    await sendWhatsAppMessage(from, reply);

    const data = extractGlucose(text);
    if (data.hasReading) {
      const { critical, urgency } = await checkCritical(data.reading, data.readingType, from);
      
      const triage = await createTriageRecord(from, data.reading, data.symptoms, reply, []);

      const reading = new GlucoseReading({
        patientPhone: from,
        reading: data.reading,
        readingType: data.readingType,
        symptoms: data.symptoms,
        notes: data.notes,
        alertSent: critical,
        triageId: triage._id
      });
      await reading.save();
      
      console.log(`âœ… ${data.reading} (${urgency})`);
    }
  } catch (e) {
    console.error('âŒ Webhook:', e.message);
  }
});

app.get('/', (req, res) => {
  res.json({
    status: 'running',
    system: 'Medical RAG',
    ai: isClaudeAvailable ? 'Claude Sonnet 4' : 'fallback',
    rag: ragSystemInitialized ? 'ready' : 'needs PDF processing',
    db: mongoose.connection.readyState === 1 ? 'ok' : 'connecting',
    setup: !ragSystemInitialized ? 'POST /admin/upload-pdf to add textbooks' : 'complete'
  });
});

// Reminders
cron.schedule('0 8 * * *', async () => {
  const patients = await Patient.find({ 'reminderPreferences.medication': true });
  for (const p of patients) {
    await sendWhatsAppMessage(p.phone, 'ğŸŒ… Morning! Meds & glucose check ğŸ˜Š');
  }
});

cron.schedule('0 20 * * *', async () => {
  const patients = await Patient.find({ 'reminderPreferences.glucoseLogging': true });
  for (const p of patients) {
    const today = await GlucoseReading.findOne({
      patientPhone: p.phone,
      timestamp: { $gte: new Date().setHours(0,0,0,0) }
    });
    if (!today) await sendWhatsAppMessage(p.phone, "ğŸŒ™ Log glucose today! ğŸ˜Š");
  }
});

app.listen(PORT, () => console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  GLUCO SAHAYAK v3.0 - RAG     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Claude: ${isClaudeAvailable ? 'âœ…' : 'âš ï¸ '}                â•‘
â•‘  RAG: ${ragSystemInitialized ? 'âœ…' : 'âš ï¸ '}                   â•‘
â•‘  DB: ${mongoose.connection.readyState === 1 ? 'âœ…' : 'â³'}                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Setup: ${!ragSystemInitialized ? 'Upload PDFs needed' : 'Complete'}  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`));
