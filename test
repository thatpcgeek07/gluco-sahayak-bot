// ========================================
// ONBOARDING SYSTEM - ADD TO YOUR server.js
// ========================================

// Updated Patient Schema with ALL fields
const patientSchema = new mongoose.Schema({
  // Phase 1: User Identity
  phone: { type: String, required: true, unique: true },
  language_pref: { type: String, enum: ['en', 'hi', 'kn'], default: 'en' }, // English, Hindi, Kannada
  full_name: String,
  age: Number,
  gender: { type: String, enum: ['Male', 'Female', 'Other'] },
  emergency_contact: String,
  pincode: String,
  consent_given: { type: Boolean, default: false },
  
  // Phase 2: Medical Profile
  diabetes_type: { type: String, enum: ['Type 1', 'Type 2', 'Gestational'] },
  duration_years: Number, // Years since diagnosis
  medication_type: { type: String, enum: ['Insulin', 'Tablets', 'Both', 'None'] },
  current_meds: [String], // List of medications
  comorbidities: [String], // BP, cholesterol, etc.
  last_hba1c: Number,
  diet_preference: { type: String, enum: ['Veg', 'Non-Veg', 'Eggetarian'] },
  
  // Onboarding Status
  onboarding_completed: { type: Boolean, default: false },
  onboarding_step: { type: String, default: 'welcome' },
  
  // Old fields (keep for compatibility)
  registeredAt: { type: Date, default: Date.now },
  medicationSchedule: [{
    medicationName: String,
    time: String,
    frequency: String
  }],
  reminderPreferences: {
    glucoseLogging: { type: Boolean, default: true },
    medication: { type: Boolean, default: true }
  }
});

// Onboarding State Schema
const onboardingStateSchema = new mongoose.Schema({
  phone: { type: String, required: true, unique: true },
  currentStep: { type: String, default: 'language' },
  data: { type: Map, of: mongoose.Schema.Types.Mixed },
  lastUpdated: { type: Date, default: Date.now }
});

const OnboardingState = mongoose.model('OnboardingState', onboardingStateSchema);

// ========================================
// MULTI-LANGUAGE RESPONSES
// ========================================

const MESSAGES = {
  welcome: {
    en: `Hello! Welcome to Gluco Sahayak! üôè

I am your personal health companion. I'm here to help you control your sugar and stay healthy.

First, select your language:
1Ô∏è‚É£ English
2Ô∏è‚É£ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
3Ô∏è‚É£ ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)

Just type 1, 2, or 3`,
    hi: `‡§®‡§Æ‡§∏‡•ç‡§§‡•á! Gluco Sahayak ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! üôè

‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§æ‡§•‡•Ä ‡§π‡•Ç‡§Ç‡•§

‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:
1Ô∏è‚É£ English
2Ô∏è‚É£ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
3Ô∏è‚É£ ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)

‡§¨‡§∏ 1, 2, ‡§Ø‡§æ 3 ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç`,
    kn: `‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞! Gluco Sahayak ‡≤ó‡≥Ü ‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§! üôè

‡≤®‡≤æ‡≤®‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤π‡≤æ‡≤Ø‡≤ï.

‡≤≠‡≤æ‡≤∑‡≥Ü ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü ‡≤Æ‡≤æ‡≤°‡≤ø:
1Ô∏è‚É£ English
2Ô∏è‚É£ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
3Ô∏è‚É£ ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)

1, 2, ‡≤Ö‡≤•‡≤µ‡≤æ 3 ‡≤ü‡≥à‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø`
  },
  
  ask_name_age: {
    en: `Great! I'll chat in English/Hindi mix so it's easy to understand. üòä

To start, please tell me:
‚Ä¢ Your Name
‚Ä¢ Your Age

Example: "My name is Ramesh Kumar, age 55"
(You can type or send a Voice Note üéôÔ∏è)`,
    hi: `‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§Æ‡•à‡§Ç English/Hindi mix ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ ‡§§‡§æ‡§ï‡§ø ‡§Ü‡§∏‡§æ‡§® ‡§π‡•ã‡•§ üòä

‡§¨‡§§‡§æ‡§á‡§è:
‚Ä¢ ‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ (Name)
‚Ä¢ ‡§â‡§Æ‡•ç‡§∞ (Age)

Example: "Mera naam Ramesh Kumar hai, umar 55 saal"
(Type ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ Voice Note ‡§≠‡•á‡§ú‡•á‡§Ç üéôÔ∏è)`,
    kn: `‡≤ö‡≥Ü‡≤®‡≥ç‡≤®‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü! ‡≤®‡≤æ‡≤®‡≥Å English/Kannada mix ‡≤®‡≤≤‡≥ç‡≤≤‡≤ø ‡≤Æ‡≤æ‡≤§‡≤®‡≤æ‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≥á‡≤®‡≥Ü. üòä

‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤π‡≥á‡≤≥‡≤ø:
‚Ä¢ ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Name)
‚Ä¢ ‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≥Å (Age)

Example: "My name is Ramesh, age 55"
(Type ‡≤Æ‡≤æ‡≤°‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ Voice Note ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤ø üéôÔ∏è)`
  },
  
  ask_gender_emergency: {
    en: `Nice to meet you, {name}! ü§ù

Please tell me:
‚Ä¢ Are you Male or Female?
‚Ä¢ Emergency contact number (family member/ASHA worker)

Example: "Male, emergency number 9876543210"`,
    hi: `{name} ji, ‡§Æ‡§ø‡§≤‡§ï‡§∞ ‡§ñ‡•Å‡§∂‡•Ä ‡§π‡•Å‡§à! ü§ù

‡§¨‡§§‡§æ‡§á‡§è:
‚Ä¢ ‡§Ü‡§™ Male ‡§π‡•à‡§Ç ‡§Ø‡§æ Female?
‚Ä¢ Emergency contact number (‡§™‡§∞‡§ø‡§µ‡§æ‡§∞/ASHA worker)

Example: "Male, emergency number 9876543210"`,
    kn: `{name}, ‡≤≠‡≥á‡≤ü‡≤ø‡≤Ø‡≤æ‡≤ó‡≤ø ‡≤∏‡≤Ç‡≤§‡≥ã‡≤∑‡≤µ‡≤æ‡≤Ø‡≤ø‡≤§‡≥Å! ü§ù

‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤π‡≥á‡≤≥‡≤ø:
‚Ä¢ ‡≤®‡≥Ä‡≤µ‡≥Å Male ‡≤Ö‡≤•‡≤µ‡≤æ Female?
‚Ä¢ Emergency contact number (‡≤ï‡≥Å‡≤ü‡≥Å‡≤Ç‡≤¨/ASHA)

Example: "Male, emergency 9876543210"`
  },
  
  ask_pincode_consent: {
    en: `Thank you! üìù

Last basic info:
‚Ä¢ Your area Pincode (6 digits)
‚Ä¢ Do you give consent for me to help manage your diabetes? (Yes/No)

Example: "Pincode 585104, Yes I consent"`,
    hi: `‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üìù

‡§Ü‡§ñ‡§ø‡§∞‡•Ä basic ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä:
‚Ä¢ ‡§Ü‡§™‡§ï‡•á area ‡§ï‡§æ Pincode (6 ‡§Ö‡§Ç‡§ï)
‚Ä¢ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Æ‡•Å‡§ù‡•á diabetes manage ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä permission ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç? (‡§π‡§æ‡§Ç/‡§®‡§π‡•Ä‡§Ç)

Example: "Pincode 585104, haan consent deta hu"`,
    kn: `‡≤ß‡≤®‡≥ç‡≤Ø‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≥Å! üìù

‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø:
‚Ä¢ ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂‡≤¶ Pincode (6 ‡≤Ö‡≤Ç‡≤ï‡≤ø‡≤ó‡≤≥‡≥Å)
‚Ä¢ Diabetes manage ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å permission? (Yes/No)

Example: "Pincode 585104, Yes consent"`
  },
  
  ask_diabetes_type: {
    en: `Perfect! Now let's talk about your sugar condition. üè•

What type of Diabetes do you have?
1Ô∏è‚É£ Type 2 (most common, usually tablets)
2Ô∏è‚É£ Type 1 (insulin from young age)
3Ô∏è‚É£ Gestational (during pregnancy)
4Ô∏è‚É£ Don't know

Just type the number.`,
    hi: `Perfect! ‡§Ö‡§¨ sugar ‡§ï‡•Ä ‡§¨‡§æ‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ üè•

‡§Ü‡§™‡§ï‡•ã ‡§ï‡•å‡§® ‡§∏‡§æ Diabetes ‡§π‡•à?
1Ô∏è‚É£ Type 2 (‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ‡§§‡§∞, tablets ‡§∏‡•á ‡§†‡•Ä‡§ï)
2Ô∏è‚É£ Type 1 (‡§¨‡§ö‡§™‡§® ‡§∏‡•á insulin)
3Ô∏è‚É£ Gestational (pregnancy ‡§Æ‡•á‡§Ç)
4Ô∏è‚É£ ‡§™‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç

Number type ‡§ï‡§∞‡•á‡§Ç‡•§`,
    kn: `‡≤∏‡≤∞‡≤ø! ‡≤à‡≤ó ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ sugar ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤Æ‡≤æ‡≤§‡≤®‡≤æ‡≤°‡≥ã‡≤£. üè•

‡≤®‡≤ø‡≤Æ‡≤ó‡≥Ü ‡≤Ø‡≤æ‡≤µ Diabetes ‡≤á‡≤¶‡≥Ü?
1Ô∏è‚É£ Type 2 (‡≤∏‡≤æ‡≤Æ‡≤æ‡≤®‡≥ç‡≤Ø, tablets)
2Ô∏è‚É£ Type 1 (‡≤ö‡≤ø‡≤ï‡≥ç‡≤ï ‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≤ø‡≤®‡≤ø‡≤Ç‡≤¶ insulin)
3Ô∏è‚É£ Gestational (pregnancy)
4Ô∏è‚É£ ‡≤ó‡≥ä‡≤§‡≥ç‡≤§‡≤ø‡≤≤‡≥ç‡≤≤

Number ‡≤ü‡≥à‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø.`
  },
  
  ask_duration: {
    en: `Got it. üìù

How many years have you had diabetes?

Example: "10 years" or "Abhi naya hai" (Just diagnosed)`,
    hi: `‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ‡•§ üìù

‡§ï‡§ø‡§§‡§®‡•á ‡§∏‡§æ‡§≤ ‡§∏‡•á diabetes ‡§π‡•à?

Example: "10 saal" ‡§Ø‡§æ "Abhi naya mila hai"`,
    kn: `‡≤Ö‡≤∞‡≥ç‡≤•‡≤µ‡≤æ‡≤Ø‡≤ø‡≤§‡≥Å. üìù

‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤µ‡≤∞‡≥ç‡≤∑‡≤ó‡≤≥‡≤ø‡≤Ç‡≤¶ diabetes ‡≤á‡≤¶‡≥Ü?

Example: "10 years" ‡≤Ö‡≤•‡≤µ‡≤æ "‡≤à‡≤ó ‡≤§‡≤æ‡≤®‡≥Ü"`
  },
  
  ask_medication: {
    en: `Important! üíä

What medicine are you taking for diabetes?
1Ô∏è‚É£ Only Tablets (‡§ó‡•ã‡§≤‡•Ä)
2Ô∏è‚É£ Only Insulin Injection
3Ô∏è‚É£ Both Tablets + Insulin
4Ô∏è‚É£ No medicine yet

Type the number.`,
    hi: `‡§¨‡§π‡•Å‡§§ important! üíä

Diabetes ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§¶‡§µ‡§æ‡§à ‡§≤‡•á‡§§‡•á ‡§π‡•à‡§Ç?
1Ô∏è‚É£ ‡§∏‡§ø‡§∞‡•ç‡§´ Tablets (‡§ó‡•ã‡§≤‡•Ä)
2Ô∏è‚É£ ‡§∏‡§ø‡§∞‡•ç‡§´ Insulin Injection
3Ô∏è‚É£ ‡§¶‡•ã‡§®‡•ã‡§Ç (Tablets + Insulin)
4Ô∏è‚É£ ‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§¶‡§µ‡§æ‡§à ‡§®‡§π‡•Ä‡§Ç

Number type ‡§ï‡§∞‡•á‡§Ç‡•§`,
    kn: `‡≤Æ‡≥Å‡≤ñ‡≥ç‡≤Ø! üíä

Diabetes ‡≤ó‡≥Ü ‡≤Ø‡≤æ‡≤µ ‡≤î‡≤∑‡≤ß ‡≤§‡≥Ü‡≤ó‡≥Ü‡≤¶‡≥Å‡≤ï‡≥ä‡≤≥‡≥ç‡≤≥‡≥Å‡≤§‡≥ç‡≤§‡≥Ä‡≤∞‡≤ø?
1Ô∏è‚É£ Tablets ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞
2Ô∏è‚É£ Insulin Injection ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞
3Ô∏è‚É£ ‡≤é‡≤∞‡≤°‡≥Ç (Tablets + Insulin)
4Ô∏è‚É£ ‡≤á‡≤®‡≥ç‡≤®‡≥Ç ‡≤î‡≤∑‡≤ß ‡≤á‡≤≤‡≥ç‡≤≤

Number ‡≤ü‡≥à‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø.`
  },
  
  ask_medicine_names: {
    en: `Good! Now I need to know exactly which medicines. üì∏

Please either:
‚Ä¢ Send a PHOTO of your medicine strip
‚Ä¢ Or TYPE the medicine names

This is very important for your safety!`,
    hi: `‡§Ö‡§ö‡•ç‡§õ‡§æ! ‡§Ö‡§¨ ‡§Æ‡•Å‡§ù‡•á exact ‡§¶‡§µ‡§æ‡§à ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ üì∏

‡§Ø‡§æ ‡§§‡•ã:
‚Ä¢ Medicine strip ‡§ï‡•Ä PHOTO ‡§≠‡•á‡§ú‡•á‡§Ç
‚Ä¢ ‡§Ø‡§æ ‡§¶‡§µ‡§æ‡§à ‡§ï‡§æ ‡§®‡§æ‡§Æ TYPE ‡§ï‡§∞‡•á‡§Ç

‡§Ø‡§π ‡§¨‡§π‡•Å‡§§ ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à ‡§Ü‡§™‡§ï‡•Ä safety ‡§ï‡•á ‡§≤‡§ø‡§è!`,
    kn: `‡≤ö‡≥Ü‡≤®‡≥ç‡≤®‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü! ‡≤à‡≤ó ‡≤®‡≤®‡≤ó‡≥Ü ‡≤®‡≤ø‡≤ñ‡≤∞ ‡≤î‡≤∑‡≤ß‡≤¶ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å ‡≤¨‡≥á‡≤ï‡≥Å. üì∏

‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å:
‚Ä¢ Medicine strip PHOTO ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤ø
‚Ä¢ ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å TYPE ‡≤Æ‡≤æ‡≤°‡≤ø

‡≤á‡≤¶‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∏‡≥Å‡≤∞‡≤ï‡≥ç‡≤∑‡≤§‡≥Ü‡≤ó‡≥Ü ‡≤Æ‡≥Å‡≤ñ‡≥ç‡≤Ø!`
  },
  
  ask_comorbidities: {
    en: `Noted! ‚úÖ

Do you also have any of these?
‚Ä¢ High BP (Blood Pressure)
‚Ä¢ High Cholesterol
‚Ä¢ Heart problem
‚Ä¢ Kidney problem

Example: "BP and Cholesterol" or "No, only diabetes"`,
    hi: `‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ! ‚úÖ

‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•ã ‡§î‡§∞ ‡§ï‡•ã‡§à ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§π‡•à?
‚Ä¢ High BP (Blood Pressure)
‚Ä¢ High Cholesterol
‚Ä¢ ‡§¶‡§ø‡§≤ ‡§ï‡•Ä problem
‚Ä¢ Kidney ‡§ï‡•Ä problem

Example: "BP aur Cholesterol" ‡§Ø‡§æ "Nahi, sirf diabetes"`,
    kn: `‡≤Ö‡≤∞‡≥ç‡≤•‡≤µ‡≤æ‡≤Ø‡≤ø‡≤§‡≥Å! ‚úÖ

‡≤®‡≤ø‡≤Æ‡≤ó‡≥Ü ‡≤á‡≤µ‡≥Å‡≤ó‡≤≥‡≤≤‡≥ç‡≤≤‡≤ø ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≤æ‡≤¶‡≤∞‡≥Ç ‡≤á‡≤¶‡≥Ü‡≤Ø‡≥á?
‚Ä¢ High BP
‚Ä¢ High Cholesterol
‚Ä¢ Heart problem
‚Ä¢ Kidney problem

Example: "BP and Cholesterol" ‡≤Ö‡≤•‡≤µ‡≤æ "‡≤á‡≤≤‡≥ç‡≤≤, diabetes ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞"`
  },
  
  ask_hba1c: {
    en: `Thank you! üìä

Last medical question:
Do you remember your last HbA1c value?
(3-month sugar average test)

Example: "8.5" or "Don't remember"`,
    hi: `‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üìä

‡§Ü‡§ñ‡§ø‡§∞‡•Ä medical question:
‡§Ü‡§™‡§ï‡§æ last HbA1c ‡§Ø‡§æ‡§¶ ‡§π‡•à?
(3 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡§æ sugar average test)

Example: "8.5" ‡§Ø‡§æ "Yaad nahi hai"`,
    kn: `‡≤ß‡≤®‡≥ç‡≤Ø‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≥Å! üìä

‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø medical ‡≤™‡≥ç‡≤∞‡≤∂‡≥ç‡≤®‡≥Ü:
‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø HbA1c ‡≤Æ‡≥å‡≤≤‡≥ç‡≤Ø ‡≤®‡≥Ü‡≤®‡≤™‡≤ø‡≤¶‡≥Ü‡≤Ø‡≥á?
(3 ‡≤§‡≤ø‡≤Ç‡≤ó‡≤≥ sugar average test)

Example: "8.5" ‡≤Ö‡≤•‡≤µ‡≤æ "‡≤®‡≥Ü‡≤®‡≤™‡≤ø‡≤≤‡≥ç‡≤≤"`
  },
  
  ask_diet: {
    en: `Almost done! üçΩÔ∏è

What do you usually eat?
1Ô∏è‚É£ Vegetarian (Veg)
2Ô∏è‚É£ Non-Vegetarian (Non-Veg)
3Ô∏è‚É£ Eggetarian (Veg + Eggs)

Type the number.`,
    hi: `‡§≤‡§ó‡§≠‡§ó ‡§π‡•ã ‡§ó‡§Ø‡§æ! üçΩÔ∏è

‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ñ‡§æ‡§§‡•á ‡§π‡•à‡§Ç usually?
1Ô∏è‚É£ ‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä (Veg)
2Ô∏è‚É£ ‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä (Non-Veg)
3Ô∏è‚É£ ‡§Ö‡§Ç‡§°‡§æ ‡§ñ‡§æ‡§§‡•á ‡§π‡•à‡§Ç (Egg)

Number type ‡§ï‡§∞‡•á‡§Ç‡•§`,
    kn: `‡≤¨‡≤π‡≥Å‡≤§‡≥á‡≤ï ‡≤Æ‡≥Å‡≤ó‡≤ø‡≤Ø‡≤ø‡≤§‡≥Å! üçΩÔ∏è

‡≤®‡≥Ä‡≤µ‡≥Å ‡≤∏‡≤æ‡≤Æ‡≤æ‡≤®‡≥ç‡≤Ø‡≤µ‡≤æ‡≤ó‡≤ø ‡≤è‡≤®‡≥Å ‡≤§‡≤ø‡≤®‡≥ç‡≤®‡≥Å‡≤§‡≥ç‡≤§‡≥Ä‡≤∞‡≤ø?
1Ô∏è‚É£ ‡≤∏‡≤∏‡≥ç‡≤Ø‡≤æ‡≤π‡≤æ‡≤∞‡≤ø (Veg)
2Ô∏è‚É£ ‡≤Æ‡≤æ‡≤Ç‡≤∏‡≤æ‡≤π‡≤æ‡≤∞‡≤ø (Non-Veg)
3Ô∏è‚É£ ‡≤Æ‡≥ä‡≤ü‡≥ç‡≤ü‡≥Ü (Egg)

Number ‡≤ü‡≥à‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø.`
  },
  
  onboarding_complete: {
    en: `Perfect! ‚úÖ Your profile is complete.

From now on, I will help you every day with:
üìä Glucose monitoring
üíä Medicine reminders
üçΩÔ∏è Diet advice
üö® Emergency alerts

Let's start! What is your current sugar reading?
(Or type "Hi" anytime to chat)`,
    hi: `Perfect! ‚úÖ ‡§Ü‡§™‡§ï‡§æ profile complete ‡§π‡•à‡•§

‡§Ö‡§¨ ‡§∏‡•á ‡§Æ‡•à‡§Ç ‡§π‡§∞ ‡§∞‡•ã‡§ú ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ:
üìä Glucose monitoring
üíä ‡§¶‡§µ‡§æ‡§à ‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§≤‡§æ‡§®‡§æ
üçΩÔ∏è Diet advice
üö® Emergency alerts

‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç! ‡§Ü‡§™‡§ï‡•Ä current sugar reading ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?
(‡§Ø‡§æ "Hi" type ‡§ï‡§∞‡•á‡§Ç ‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è)`,
    kn: `‡≤™‡≤∞‡≤ø‡≤™‡≥Ç‡≤∞‡≥ç‡≤£! ‚úÖ ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ profile ‡≤™‡≥Ç‡≤∞‡≥ç‡≤£‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü.

‡≤à‡≤ó‡≤ø‡≤®‡≤ø‡≤Ç‡≤¶ ‡≤®‡≤æ‡≤®‡≥Å ‡≤™‡≥ç‡≤∞‡≤§‡≤ø‡≤¶‡≤ø‡≤® ‡≤∏‡≤π‡≤æ‡≤Ø ‡≤Æ‡≤æ‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≥á‡≤®‡≥Ü:
üìä Glucose monitoring
üíä Medicine reminders
üçΩÔ∏è Diet advice
üö® Emergency alerts

‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≥ã‡≤£! ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ current sugar reading ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å?
(‡≤Ö‡≤•‡≤µ‡≤æ "Hi" ‡≤ü‡≥à‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø ‡≤Æ‡≤æ‡≤§‡≤®‡≤æ‡≤°‡≤≤‡≥Å)`
  }
};

// ========================================
// ONBOARDING LOGIC
// ========================================

async function handleOnboarding(phone, message, messageType = 'text', mediaData = null) {
  try {
    // Get or create onboarding state
    let state = await OnboardingState.findOne({ phone });
    
    if (!state) {
      state = await OnboardingState.create({
        phone,
        currentStep: 'language',
        data: new Map()
      });
    }

    const lower = message.toLowerCase();
    let response = '';
    let nextStep = state.currentStep;
    let lang = state.data.get('language_pref') || 'en';

    // Step-by-step onboarding flow
    switch (state.currentStep) {
      case 'language':
        // User selects language
        if (lower.includes('1') || lower.includes('english')) {
          lang = 'en';
        } else if (lower.includes('2') || lower.includes('hindi') || lower.includes('‡§π‡§ø‡§Ç‡§¶‡•Ä')) {
          lang = 'hi';
        } else if (lower.includes('3') || lower.includes('kannada') || lower.includes('‡≤ï‡≤®‡≥ç‡≤®‡≤°')) {
          lang = 'kn';
        }
        
        state.data.set('language_pref', lang);
        nextStep = 'name_age';
        response = MESSAGES.ask_name_age[lang];
        break;

      case 'name_age':
        // Extract name and age
        const nameAgeMatch = message.match(/(?:name|naam|‡≤®‡≤æ‡≤®‡≥Å|‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å)[\s:]*([a-zA-Z\s]+)[\s,]+(?:age|umar|‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≥Å|years?)[\s:]*(\d+)/i);
        
        if (nameAgeMatch) {
          state.data.set('full_name', nameAgeMatch[1].trim());
          state.data.set('age', parseInt(nameAgeMatch[2]));
          
          nextStep = 'gender_emergency';
          const name = nameAgeMatch[1].trim().split(' ')[0]; // First name
          response = MESSAGES.ask_gender_emergency[lang].replace('{name}', name);
        } else {
          response = "I didn't quite get that. Please tell me: Name and Age\nExample: 'My name is Ramesh, age 55'";
        }
        break;

      case 'gender_emergency':
        // Extract gender and emergency contact
        let gender = null;
        if (lower.includes('male') || lower.includes('‡§™‡•Å‡§∞‡•Å‡§∑')) gender = 'Male';
        if (lower.includes('female') || lower.includes('‡§Æ‡§π‡§ø‡§≤‡§æ')) gender = 'Female';
        
        const phoneMatch = message.match(/(\d{10})/);
        
        if (gender && phoneMatch) {
          state.data.set('gender', gender);
          state.data.set('emergency_contact', '+91' + phoneMatch[1]);
          
          nextStep = 'pincode_consent';
          response = MESSAGES.ask_pincode_consent[lang];
        } else {
          response = "Please tell me: Gender (Male/Female) and Emergency contact number (10 digits)";
        }
        break;

      case 'pincode_consent':
        // Extract pincode and consent
        const pincodeMatch = message.match(/(\d{6})/);
        const hasConsent = lower.includes('yes') || lower.includes('‡§π‡§æ‡§Ç') || lower.includes('ha') || 
                          lower.includes('consent') || lower.includes('‡≤π‡≥å‡≤¶‡≥Å');
        
        if (pincodeMatch && hasConsent) {
          state.data.set('pincode', pincodeMatch[1]);
          state.data.set('consent_given', true);
          
          nextStep = 'diabetes_type';
          response = MESSAGES.ask_diabetes_type[lang];
        } else {
          response = "Please tell me: Pincode (6 digits) and Yes/No for consent";
        }
        break;

      case 'diabetes_type':
        let diabetesType = 'Type 2'; // Default
        
        if (lower.includes('1') || lower.includes('type 1')) {
          diabetesType = 'Type 1';
        } else if (lower.includes('2') || lower.includes('type 2')) {
          diabetesType = 'Type 2';
        } else if (lower.includes('3') || lower.includes('gestational')) {
          diabetesType = 'Gestational';
        }
        
        state.data.set('diabetes_type', diabetesType);
        nextStep = 'duration';
        response = MESSAGES.ask_duration[lang];
        break;

      case 'duration':
        // Extract duration in years
        const yearMatch = message.match(/(\d+)/);
        const duration = yearMatch ? parseInt(yearMatch[1]) : 0;
        
        state.data.set('duration_years', duration);
        nextStep = 'medication';
        response = MESSAGES.ask_medication[lang];
        break;

      case 'medication':
        let medType = 'Tablets';
        
        if (lower.includes('1') || lower.includes('tablet') || lower.includes('‡§ó‡•ã‡§≤‡•Ä')) {
          medType = 'Tablets';
        } else if (lower.includes('2') || lower.includes('insulin')) {
          medType = 'Insulin';
        } else if (lower.includes('3') || lower.includes('both') || lower.includes('‡§¶‡•ã‡§®‡•ã‡§Ç')) {
          medType = 'Both';
        } else if (lower.includes('4') || lower.includes('no') || lower.includes('‡§®‡§π‡•Ä‡§Ç')) {
          medType = 'None';
        }
        
        state.data.set('medication_type', medType);
        nextStep = 'medicine_names';
        response = MESSAGES.ask_medicine_names[lang];
        break;

      case 'medicine_names':
        // Handle photo or text
        if (messageType === 'image' && mediaData) {
          // TODO: OCR processing for medicine strip
          response = "üì∏ Got your medicine photo! Processing...\n\nFor now, please also TYPE the medicine names if you know them.";
          state.data.set('medicine_photo_received', true);
          // Stay on same step for text input
        } else {
          // Extract medicine names
          const commonMeds = ['metformin', 'glimepiride', 'glyburide', 'insulin', 'glargine', 'lispro'];
          const foundMeds = [];
          
          commonMeds.forEach(med => {
            if (lower.includes(med)) {
              foundMeds.push(med.charAt(0).toUpperCase() + med.slice(1));
            }
          });
          
          if (foundMeds.length > 0 || lower.includes('no medicine') || lower.includes('‡§ï‡•ã‡§à ‡§®‡§π‡•Ä‡§Ç')) {
            state.data.set('current_meds', foundMeds.length > 0 ? foundMeds : ['None']);
            nextStep = 'comorbidities';
            response = MESSAGES.ask_comorbidities[lang];
          } else {
            response = "Please tell me medicine names or send photo üì∏";
          }
        }
        break;

      case 'comorbidities':
        const comorbidities = [];
        
        if (lower.includes('bp') || lower.includes('blood pressure') || lower.includes('hypertension')) {
          comorbidities.push('Hypertension');
        }
        if (lower.includes('cholesterol')) {
          comorbidities.push('High Cholesterol');
        }
        if (lower.includes('heart') || lower.includes('‡§¶‡§ø‡§≤')) {
          comorbidities.push('Heart Disease');
        }
        if (lower.includes('kidney')) {
          comorbidities.push('Kidney Disease');
        }
        
        state.data.set('comorbidities', comorbidities.length > 0 ? comorbidities : ['None']);
        nextStep = 'hba1c';
        response = MESSAGES.ask_hba1c[lang];
        break;

      case 'hba1c':
        const hba1cMatch = message.match(/(\d+\.?\d*)/);
        
        if (hba1cMatch) {
          state.data.set('last_hba1c', parseFloat(hba1cMatch[1]));
        } else {
          state.data.set('last_hba1c', null);
        }
        
        nextStep = 'diet';
        response = MESSAGES.ask_diet[lang];
        break;

      case 'diet':
        let diet = 'Veg';
        
        if (lower.includes('1') || lower.includes('veg') || lower.includes('‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä')) {
          diet = 'Veg';
        } else if (lower.includes('2') || lower.includes('non-veg') || lower.includes('‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä')) {
          diet = 'Non-Veg';
        } else if (lower.includes('3') || lower.includes('egg')) {
          diet = 'Eggetarian';
        }
        
        state.data.set('diet_preference', diet);
        
        // ONBOARDING COMPLETE!
        await savePatientData(phone, state.data);
        nextStep = 'completed';
        response = MESSAGES.onboarding_complete[lang];
        break;
    }

    // Update state
    state.currentStep = nextStep;
    state.lastUpdated = new Date();
    await state.save();

    return { response, completed: nextStep === 'completed' };

  } catch (error) {
    console.error('‚ùå Onboarding error:', error);
    return { 
      response: "Sorry, something went wrong. Let's try again. Type 'start' to begin.",
      completed: false 
    };
  }
}

// Save completed onboarding data to Patient
async function savePatientData(phone, dataMap) {
  try {
    const patientData = {
      phone,
      language_pref: dataMap.get('language_pref'),
      full_name: dataMap.get('full_name'),
      age: dataMap.get('age'),
      gender: dataMap.get('gender'),
      emergency_contact: dataMap.get('emergency_contact'),
      pincode: dataMap.get('pincode'),
      consent_given: dataMap.get('consent_given'),
      diabetes_type: dataMap.get('diabetes_type'),
      duration_years: dataMap.get('duration_years'),
      medication_type: dataMap.get('medication_type'),
      current_meds: dataMap.get('current_meds'),
      comorbidities: dataMap.get('comorbidities'),
      last_hba1c: dataMap.get('last_hba1c'),
      diet_preference: dataMap.get('diet_preference'),
      onboarding_completed: true,
      onboarding_step: 'completed'
    };

    await Patient.findOneAndUpdate(
      { phone },
      patientData,
      { upsert: true, new: true }
    );

    console.log(`‚úÖ Patient onboarding completed: ${patientData.full_name}`);
  } catch (error) {
    console.error('‚ùå Error saving patient:', error);
  }
}

// Check if user needs onboarding
async function checkOnboardingStatus(phone) {
  const patient = await Patient.findOne({ phone });
  
  if (!patient || !patient.onboarding_completed) {
    return { needsOnboarding: true, step: patient?.onboarding_step || 'language' };
  }
  
  return { needsOnboarding: false };
}

// ========================================
// EXPORT THESE FUNCTIONS
// ========================================

module.exports = {
  handleOnboarding,
  checkOnboardingStatus,
  MESSAGES
};
