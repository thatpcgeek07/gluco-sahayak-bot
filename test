const express = require('express');
const axios = require('axios');
const mongoose = require('mongoose');
const cron = require('node-cron');
const pdfParse = require('pdf-parse');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.json());

// Configuration
const PORT = process.env.PORT || 3000;
const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_ID = process.env.WHATSAPP_PHONE_ID;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN;
const MONGODB_URI = process.env.MONGODB_URI;
const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;
const PHYSICIAN_PHONE = process.env.PHYSICIAN_PHONE;

// â­ YOUR GOOGLE DRIVE FILES - CONFIGURED! â­
const MEDICAL_PDF_FILES = [
  { 
    fileId: '1bG1owFgs9AfJRc3c8XGJDTGzshyVqfYM', 
    filename: 'medical_textbook_1.pdf', 
    source: 'Medical_Reference_1' 
  },
  { 
    fileId: '1H3SmbA4ZMQ3hKcuoG-AoRkdU8Kyh9t1j', 
    filename: 'medical_textbook_2.pdf', 
    source: 'Medical_Reference_2' 
  },
  { 
    fileId: '1vYC0ncfuz1nsVldijZG3uG_ZzWc_MH9N', 
    filename: 'medical_textbook_3.pdf', 
    source: 'Medical_Reference_3' 
  },
  { 
    fileId: '127OJ05vyE3b7KcFvjTJZWmekHmCAwukA', 
    filename: 'medical_textbook_4.pdf', 
    source: 'Medical_Reference_4' 
  }
];

// Claude Sonnet 4
const CLAUDE_API_URL = 'https://api.anthropic.com/v1/messages';
const CLAUDE_MODEL = 'claude-sonnet-4-20250514';
let isClaudeAvailable = false;
let ragSystemInitialized = false;

// Medical Knowledge Base Schema
const medicalKnowledgeSchema = new mongoose.Schema({
  source: { type: String, required: true },
  content: { type: String, required: true },
  keywords: [String],
  pageNumber: Number,
  chunkIndex: Number,
  lastUpdated: { type: Date, default: Date.now }
});

medicalKnowledgeSchema.index({ content: 'text', keywords: 'text' });
medicalKnowledgeSchema.index({ source: 1, keywords: 1 });

const MedicalKnowledge = mongoose.model('MedicalKnowledge', medicalKnowledgeSchema);

// Triage Schema
const triageSchema = new mongoose.Schema({
  patientPhone: String,
  timestamp: { type: Date, default: Date.now },
  urgencyLevel: { 
    type: String, 
    enum: ['EMERGENCY', 'URGENT', 'ROUTINE', 'MONITORING'],
    required: true 
  },
  symptoms: [String],
  glucoseReading: Number,
  aiAssessment: String,
  medicalReferences: [{ source: String, content: String }],
  physicianAlerted: Boolean
});

const Triage = mongoose.model('Triage', triageSchema);

// Patient schemas
const patientSchema = new mongoose.Schema({
  phone: String,
  name: String,
  age: Number,
  diabetesType: String,
  registeredAt: { type: Date, default: Date.now },
  medicationSchedule: [{ medicationName: String, time: String }],
  reminderPreferences: { glucoseLogging: Boolean, medication: Boolean }
});

const glucoseReadingSchema = new mongoose.Schema({
  patientPhone: String,
  reading: Number,
  readingType: { type: String, enum: ['fasting', 'postprandial', 'random'] },
  timestamp: { type: Date, default: Date.now },
  symptoms: [String],
  notes: String,
  alertSent: Boolean,
  triageId: mongoose.Schema.Types.ObjectId
});

const conversationSchema = new mongoose.Schema({
  patientPhone: String,
  messages: [{ role: String, content: String, timestamp: Date }],
  lastActive: Date
});

const Patient = mongoose.model('Patient', patientSchema);
const GlucoseReading = mongoose.model('GlucoseReading', glucoseReadingSchema);
const Conversation = mongoose.model('Conversation', conversationSchema);

mongoose.connect(MONGODB_URI).then(async () => {
  console.log('âœ… MongoDB connected');
  await initializeRAGSystem();
}).catch(err => console.error('âŒ MongoDB:', err.message));

// ========================================
// RAG SYSTEM INITIALIZATION
// ========================================

async function initializeRAGSystem() {
  try {
    const existingCount = await MedicalKnowledge.countDocuments();
    
    if (existingCount > 50) {
      console.log(`âœ… RAG System ready (${existingCount} chunks)`);
      ragSystemInitialized = true;
      return;
    }

    console.log('ğŸ“š RAG not initialized');
    console.log('ğŸ“ To process your PDFs, call: POST /admin/process-pdfs');
    console.log(`ğŸ“‚ ${MEDICAL_PDF_FILES.length} textbooks configured`);
    
    ragSystemInitialized = false;
  } catch (error) {
    console.error('âŒ RAG init error:', error.message);
  }
}

// ========================================
// PDF PROCESSING
// ========================================

function extractKeywords(text) {
  const keywords = [];
  const terms = [
    'diabetes', 'glucose', 'insulin', 'hyperglycemia', 'hypoglycemia',
    'HbA1c', 'blood sugar', 'pancreas', 'type 1', 'type 2',
    'metformin', 'glycemic', 'fasting', 'postprandial', 'complications',
    'retinopathy', 'neuropathy', 'nephropathy', 'cardiovascular',
    'diet', 'exercise', 'medication', 'management', 'monitoring'
  ];

  const lower = text.toLowerCase();
  terms.forEach(term => {
    if (lower.includes(term)) keywords.push(term);
  });

  return [...new Set(keywords)];
}

async function downloadFromGoogleDrive(fileId, filename) {
  try {
    console.log(`ğŸ“¥ Downloading ${filename}...`);
    
    const url = `https://drive.google.com/uc?export=download&id=${fileId}`;
    
    const response = await axios({
      method: 'GET',
      url: url,
      responseType: 'arraybuffer',
      timeout: 120000
    });

    const filePath = path.join('/tmp', filename);
    fs.writeFileSync(filePath, response.data);
    
    console.log(`âœ… Downloaded: ${filename}`);
    return filePath;
  } catch (error) {
    console.error(`âŒ Download failed: ${error.message}`);
    
    try {
      const altUrl = `https://drive.google.com/u/0/uc?id=${fileId}&export=download&confirm=t`;
      const response = await axios({
        method: 'GET',
        url: altUrl,
        responseType: 'arraybuffer',
        timeout: 120000
      });
      
      const filePath = path.join('/tmp', filename);
      fs.writeFileSync(filePath, response.data);
      console.log(`âœ… Downloaded (alt method)`);
      return filePath;
    } catch (altError) {
      console.error(`âŒ Alt download failed: ${altError.message}`);
      return null;
    }
  }
}

async function processPDFFile(filePath, source) {
  try {
    console.log(`ğŸ“– Processing ${source}...`);
    
    const dataBuffer = fs.readFileSync(filePath);
    const data = await pdfParse(dataBuffer);
    
    console.log(`ğŸ“„ Pages: ${data.numpages}`);

    const paragraphs = data.text
      .split(/\n\s*\n/)
      .map(p => p.trim())
      .filter(p => p.length > 200 && p.length < 2000);

    console.log(`ğŸ“¦ ${paragraphs.length} chunks`);

    let saved = 0;

    for (let i = 0; i < paragraphs.length; i++) {
      const chunk = paragraphs[i];
      const keywords = extractKeywords(chunk);
      
      if (keywords.length > 0) {
        await MedicalKnowledge.create({
          source,
          content: chunk,
          keywords,
          pageNumber: Math.floor((i / paragraphs.length) * data.numpages),
          chunkIndex: i
        });
        saved++;
      }

      if ((i + 1) % 50 === 0) {
        console.log(`   ${i + 1}/${paragraphs.length}`);
      }
    }

    console.log(`âœ… ${source}: ${saved} chunks saved`);
    
    try {
      fs.unlinkSync(filePath);
    } catch (e) {}
    
    return saved;
  } catch (error) {
    console.error(`âŒ Processing error: ${error.message}`);
    return 0;
  }
}

// ========================================
// ADMIN ENDPOINT - PROCESS YOUR PDFs
// ========================================

app.post('/admin/process-pdfs', async (req, res) => {
  res.json({ 
    status: 'started',
    message: 'Processing your 4 medical textbooks. Check logs.',
    files: MEDICAL_PDF_FILES.length
  });

  // Process in background
  processAllPDFs();
});

async function processAllPDFs() {
  console.log('\nğŸ¥ PROCESSING YOUR MEDICAL PDFs\n');

  let totalChunks = 0;

  for (let i = 0; i < MEDICAL_PDF_FILES.length; i++) {
    const file = MEDICAL_PDF_FILES[i];
    
    console.log(`\n[${i + 1}/${MEDICAL_PDF_FILES.length}] ${file.source}`);

    const filePath = await downloadFromGoogleDrive(file.fileId, file.filename);
    
    if (filePath) {
      const chunks = await processPDFFile(filePath, file.source);
      totalChunks += chunks;
    }
  }

  ragSystemInitialized = totalChunks > 0;

  console.log(`\nâœ… DONE! ${totalChunks} total chunks\n`);
}

// Check status
app.get('/admin/rag-status', async (req, res) => {
  const totalChunks = await MedicalKnowledge.countDocuments();
  const bySource = await MedicalKnowledge.aggregate([
    { $group: { _id: '$source', count: { $sum: 1 } } }
  ]);

  res.json({
    initialized: ragSystemInitialized,
    totalChunks,
    bySource,
    ready: totalChunks > 50,
    files: MEDICAL_PDF_FILES.map(f => f.source)
  });
});

// ========================================
// RAG RETRIEVAL
// ========================================

async function retrieveMedicalKnowledge(query, topK = 5) {
  try {
    const results = await MedicalKnowledge
      .find(
        { $text: { $search: query } },
        { score: { $meta: 'textScore' } }
      )
      .sort({ score: { $meta: 'textScore' } })
      .limit(topK);

    if (results.length === 0) {
      const keywords = extractKeywords(query);
      if (keywords.length > 0) {
        return await MedicalKnowledge.find({ keywords: { $in: keywords } }).limit(topK);
      }
    }

    return results;
  } catch (error) {
    return [];
  }
}

// ========================================
// TRIAGE
// ========================================

function assessUrgency(glucose, symptoms = []) {
  if (glucose < 54 || glucose > 400) return 'EMERGENCY';
  if (symptoms.some(s => ['unconscious', 'confusion', 'seizure'].includes(s.toLowerCase()))) {
    return 'EMERGENCY';
  }
  if (glucose < 70 || glucose > 250) return 'URGENT';
  if (glucose > 180 || glucose < 80) return 'ROUTINE';
  return 'MONITORING';
}

async function createTriageRecord(phone, glucose, symptoms, aiAssessment, medicalRefs) {
  const urgency = assessUrgency(glucose, symptoms);
  
  await Triage.create({
    patientPhone: phone,
    urgencyLevel: urgency,
    symptoms,
    glucoseReading: glucose,
    aiAssessment,
    medicalReferences: medicalRefs,
    physicianAlerted: urgency === 'EMERGENCY' || urgency === 'URGENT'
  });

  console.log(`ğŸ¥ Triage: ${urgency}`);
  return urgency;
}

// ========================================
// CLAUDE
// ========================================

async function initializeClaude() {
  if (!ANTHROPIC_API_KEY) return false;

  try {
    const response = await axios.post(CLAUDE_API_URL, {
      model: CLAUDE_MODEL,
      max_tokens: 50,
      messages: [{ role: 'user', content: 'Hi' }]
    }, {
      headers: {
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json'
      }
    });

    if (response.data?.content?.[0]?.text) {
      isClaudeAvailable = true;
      console.log('âœ… Claude ready');
      return true;
    }
  } catch (error) {
    console.error('âŒ Claude failed');
  }
  return false;
}

initializeClaude();

const THRESHOLDS = {
  fasting: { critical_low: 70, critical_high: 250 },
  postprandial: { critical_low: 70, critical_high: 300 },
  random: { critical_low: 70, critical_high: 250 }
};

// ========================================
// WHATSAPP
// ========================================

async function sendWhatsAppMessage(to, message) {
  try {
    await axios.post(`https://graph.facebook.com/v18.0/${WHATSAPP_PHONE_ID}/messages`, {
      messaging_product: 'whatsapp',
      to,
      type: 'text',
      text: { body: message }
    }, { headers: { 'Authorization': `Bearer ${WHATSAPP_TOKEN}` } });
    console.log(`âœ… Sent`);
  } catch (e) {
    console.error('âŒ Send failed');
  }
}

// ========================================
// FALLBACK
// ========================================

function fallbackResponse(msg) {
  const lower = msg.toLowerCase();
  const num = msg.match(/(\d{2,3})/);
  const glucose = num ? parseInt(num[1]) : null;
  
  if (lower.match(/^(hi|hello|namaste)/)) {
    return `Hello! ğŸ™ Gluco Sahayak - Medical-grade diabetes assistant.\n\nğŸ“š Evidence-based guidance\nğŸ“Š Glucose tracking\nğŸ¥ Emergency protocols\n\nSend: "My sugar is 120" ğŸ˜Š`;
  }
  
  if (glucose && glucose >= 40 && glucose <= 500) {
    let r = `âœ… Logged: ${glucose} mg/dL\n\n`;
    
    if (glucose < 54) r += `ğŸš¨ğŸš¨ EMERGENCY! Severe hypoglycemia. Eat 15g carbs NOW! Call doctor!`;
    else if (glucose < 70) r += `ğŸš¨ LOW! Eat 15g fast carbs. Rest 15min. Recheck.`;
    else if (glucose <= 100) r += `âœ… EXCELLENT! Normal range ğŸ‘`;
    else if (glucose <= 125) r += `âš ï¸ PREDIABETES. More veggies, walk 30min, see doctor.`;
    else if (glucose <= 180) r += `âš ï¸ ELEVATED. Review diet, exercise, meds.`;
    else if (glucose <= 250) r += `ğŸš¨ HIGH! Water, no sweets, walk 15min, recheck 2hr.`;
    else if (glucose <= 400) r += `ğŸš¨ğŸš¨ SEVERE! Contact doctor NOW!`;
    else r += `ğŸš¨ğŸš¨ğŸš¨ CRITICAL! Go to ER immediately!`;
    
    return r;
  }
  
  return `How can I help?\nğŸ“Š "My sugar is 120"\nğŸ½ï¸ "Diet advice"\nğŸš¶ "Exercise tips"`;
}

// ========================================
// CLAUDE WITH RAG
// ========================================

async function analyzeWithClaudeRAG(phone, msg) {
  if (!isClaudeAvailable) return fallbackResponse(msg);

  try {
    const medicalContext = ragSystemInitialized 
      ? await retrieveMedicalKnowledge(msg, 5)
      : [];
    
    const patient = await Patient.findOne({ phone });
    const readings = await GlucoseReading.find({ patientPhone: phone })
      .sort({ timestamp: -1 }).limit(5);

    const references = medicalContext.length > 0
      ? medicalContext.map(doc => `[${doc.source}]\n${doc.content.substring(0, 500)}...`).join('\n\n')
      : 'Standard medical protocols.';

    const system = `You are Gluco Sahayak, medical-grade diabetes assistant.

ğŸ¥ RULES:
1. Use ONLY information from textbook excerpts below
2. Cite source: [Source Name]
3. If no excerpt, say "Based on standard protocols"
4. Safety warnings for critical glucose

ğŸ“š MEDICAL EXCERPTS:
${references}

PATIENT:
- ${patient?.name || 'New'}
- Recent: ${readings.map(r => `${r.reading}mg/dL`).join(', ') || 'None'}

PROTOCOL:
1. Assess urgency
2. Cite textbook
3. Evidence-based advice
4. Indian context (roti, dal, yoga)
5. Max 150 words

User: "${msg}"

Respond with citations:`;

    const response = await axios.post(CLAUDE_API_URL, {
      model: CLAUDE_MODEL,
      max_tokens: 500,
      system,
      messages: [{ role: 'user', content: msg }]
    }, {
      headers: {
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json'
      },
      timeout: 15000
    });

    const text = response.data?.content?.[0]?.text;
    if (text) {
      console.log(`âœ… Claude RAG (${medicalContext.length} refs)`);
      return text;
    }
  } catch (e) {
    console.error('âŒ Claude error');
  }
  
  return fallbackResponse(msg);
}

function extractGlucose(msg) {
  const match = msg.match(/(\d{2,3})/);
  const reading = match ? parseInt(match[1]) : null;
  if (!reading || reading < 40 || reading > 500) return { hasReading: false };

  const lower = msg.toLowerCase();
  const type = lower.match(/fasting|empty|morning/) ? 'fasting' :
               lower.match(/after|post|lunch|dinner/) ? 'postprandial' : 'random';

  const symptoms = [];
  ['tired', 'dizzy', 'thirsty', 'blur', 'sweat', 'weak'].forEach(s => {
    if (lower.includes(s)) symptoms.push(s);
  });

  return { hasReading: true, reading, readingType: type, symptoms, notes: msg.substring(0, 200) };
}

async function checkCritical(reading, type, phone) {
  const t = THRESHOLDS[type] || THRESHOLDS.random;
  let critical = false;
  let urgency = 'MONITORING';

  if (reading < 54 || reading > 400) {
    critical = true;
    urgency = 'EMERGENCY';
  } else if (reading < t.critical_low || reading > t.critical_high) {
    critical = true;
    urgency = 'URGENT';
  }

  if (critical && PHYSICIAN_PHONE && PHYSICIAN_PHONE !== '+919876543210') {
    await sendWhatsAppMessage(PHYSICIAN_PHONE, 
      `ğŸš¨ ${urgency}\nPatient: ${phone}\nGlucose: ${reading} mg/dL`);
  }

  return { critical, urgency };
}

// ========================================
// WEBHOOKS
// ========================================

app.get('/webhook', (req, res) => {
  if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === VERIFY_TOKEN) {
    return res.status(200).send(req.query['hub.challenge']);
  }
  res.sendStatus(403);
});

app.post('/webhook', async (req, res) => {
  res.sendStatus(200);

  try {
    const msg = req.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
    if (!msg || msg.type !== 'text') return;

    const from = msg.from;
    const text = msg.text.body;

    const reply = await analyzeWithClaudeRAG(from, text);
    await sendWhatsAppMessage(from, reply);

    const data = extractGlucose(text);
    if (data.hasReading) {
      const { critical, urgency } = await checkCritical(data.reading, data.readingType, from);
      
      await createTriageRecord(from, data.reading, data.symptoms, reply, []);

      await GlucoseReading.create({
        patientPhone: from,
        reading: data.reading,
        readingType: data.readingType,
        symptoms: data.symptoms,
        notes: data.notes,
        alertSent: critical
      });
      
      console.log(`âœ… ${data.reading} (${urgency})`);
    }
  } catch (e) {
    console.error('âŒ Webhook:', e.message);
  }
});

app.get('/', (req, res) => {
  res.json({
    status: 'running',
    ai: isClaudeAvailable ? 'Claude Sonnet 4' : 'fallback',
    rag: ragSystemInitialized ? 'ready' : 'call POST /admin/process-pdfs',
    files: MEDICAL_PDF_FILES.length
  });
});

// ========================================
// REMINDERS
// ========================================

cron.schedule('0 8 * * *', async () => {
  const patients = await Patient.find({ 'reminderPreferences.medication': true });
  for (const p of patients) {
    await sendWhatsAppMessage(p.phone, 'ğŸŒ… Morning! Meds & glucose check ğŸ˜Š');
  }
});

cron.schedule('0 20 * * *', async () => {
  const patients = await Patient.find({ 'reminderPreferences.glucoseLogging': true });
  for (const p of patients) {
    const today = await GlucoseReading.findOne({
      patientPhone: p.phone,
      timestamp: { $gte: new Date().setHours(0,0,0,0) }
    });
    if (!today) await sendWhatsAppMessage(p.phone, "ğŸŒ™ Log glucose! ğŸ˜Š");
  }
});

app.listen(PORT, () => console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  GLUCO SAHAYAK v3.0 - RAG     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Claude: ${isClaudeAvailable ? 'âœ…' : 'âš ï¸ '}                â•‘
â•‘  RAG: ${ragSystemInitialized ? 'âœ…' : 'âš ï¸ '}                   â•‘
â•‘  Files: ${MEDICAL_PDF_FILES.length}                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
To process PDFs: POST /admin/process-pdfs
`));
